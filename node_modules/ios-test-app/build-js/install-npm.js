'use strict';

var xcode = require('appium-xcode'),
    fs = require('fs'),
    path = require('path'),
    gutil = require('gulp-util'),
    asyncUtil = require('async'),
    rimraf = require('rimraf'),
    exec = require('child_process').exec;

var rootDir = process.env.NO_PRECOMPILE ? path.resolve(__dirname) : path.resolve(__dirname, '..');

var relative = {
  iphoneos: 'build/Release-iphoneos/TestApp-iphoneos.app',
  iphonesimulator: 'build/Release-iphonesimulator/TestApp-iphonesimulator.app'
};

var absolute = {
  iphoneos: path.resolve(rootDir, 'build', 'Release-iphoneos', 'TestApp-iphoneos.app'),
  iphonesimulator: path.resolve(rootDir, 'build', 'Release-iphonesimulator', 'TestApp-iphonesimulator.app')
};

var appList = [relative.iphoneos, relative.iphonesimulator];

var SDKS = {
  iphonesimulator: {
    name: 'iphonesimulator',
    buildPath: path.resolve('build', 'Release-iphonesimulator', 'TestApp.app'),
    finalPath: relative.iphonesimulator
  },
  iphoneos: {
    name: 'iphoneos',
    buildPath: path.resolve('build', 'Release-iphoneos', 'TestApp.app'),
    finalPath: relative.iphoneos
  }
};

// the sdks against which we will build
var sdks = ['iphonesimulator'];
if (process.env.IOS_REAL_DEVICE || process.env.REAL_DEVICE) {
  sdks.push('iphoneos');
}

var MAX_BUFFER_SIZE = 524288;

function cleanApp(appRoot, sdk, done) {
  gutil.log('cleaning app for ' + sdk);
  var cmd = 'xcodebuild -sdk ' + sdk + ' clean';
  exec(cmd, { cwd: appRoot, maxBuffer: MAX_BUFFER_SIZE }, function (err, stdout, stderr) {
    if (err) {
      gutil.log("Failed cleaning app");
      gutil.log(stderr);
      done(err);
    } else {
      gutil.log('finished cleaning app for ' + sdk);
      done();
    }
  });
}

function cleanAll(done) {
  gutil.log("cleaning apps");
  xcode.getMaxIOSSDK()['catch'](function (err) {
    gutil.log("Unable to get max iOS SDK:", err.message);
  }).then(function (sdkVer) {
    asyncUtil.eachSeries(sdks, function (sdk, cb) {
      cleanApp('.', sdk + sdkVer, cb);
    }, function (err) {
      if (err) return done(err);
      asyncUtil.eachSeries([SDKS.iphonesimulator.buildPath, SDKS.iphonesimulator.finalPath, SDKS.iphoneos.buildPath, SDKS.iphoneos.finalPath], rimraf, function (err) {
        if (err) return done(err);
        gutil.log("finished cleaning apps");
        done();
      });
    });
  });
}

function buildApp(appRoot, sdk, done) {
  gutil.log('building app for ' + sdk);
  var cmd = 'xcodebuild -sdk ' + sdk;
  exec(cmd, { cwd: appRoot, maxBuffer: MAX_BUFFER_SIZE }, function (err, stdout, stderr) {
    if (err) {
      gutil.log("Failed building app");
      gutil.log(stderr);
      done(err);
    } else {
      gutil.log('finished building app for ' + sdk);
      done();
    }
  });
}

function buildAll(done) {
  gutil.log('building apps');
  xcode.getMaxIOSSDK().then(function (sdkVer) {
    asyncUtil.eachSeries(sdks, function (sdk, cb) {
      buildApp('.', sdk + sdkVer, cb);
    }, function (err) {
      if (err) return done(err);
      gutil.log('finished building apps');
      done();
    });
  });
}

function renameAll(done) {
  gutil.log('renaming apps');
  asyncUtil.eachSeries(sdks, function (sdk, cb) {
    gutil.log('renaming for ' + sdk);
    fs.rename(SDKS[sdk].buildPath, SDKS[sdk].finalPath, cb);
  }, function (err) {
    if (err) return done(err);
    gutil.log('finished renaming apps');
    done();
  });
}

exports.install = function install(done) {
  asyncUtil.series([cleanAll, buildAll, renameAll, function () {
    if (typeof done === 'function') {
      done();
    }
  }]);
};

exports.installRealDevice = function installRealDevice(done) {
  sdks = ['iphoneos'];
  exports.install(function () {
    done(SDKS.iphoneos.finalPath);
  });
};

exports.relative = relative;
exports.absolute = absolute;
exports.appList = appList;

if (require.main === module) {
  exports.install(function () {
    console.log('finished installing');
  });
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsT0FBTyxHQUFHLE9BQU8sQ0FBQzs7QUFFMUIsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtBQUMzQixTQUFPLENBQUMsT0FBTyxDQUFDLFlBQVk7QUFDMUIsV0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0dBQ3BDLENBQUMsQ0FBQztDQUNKIiwiZmlsZSI6Imluc3RhbGwtbnBtLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgeGNvZGUgPSByZXF1aXJlKCdhcHBpdW0teGNvZGUnKSxcbiAgICBmcyA9IHJlcXVpcmUoJ2ZzJyksXG4gICAgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKSxcbiAgICBndXRpbCA9IHJlcXVpcmUoJ2d1bHAtdXRpbCcpLFxuICAgIGFzeW5jVXRpbCA9IHJlcXVpcmUoJ2FzeW5jJyksXG4gICAgcmltcmFmID0gcmVxdWlyZSgncmltcmFmJyksXG4gICAgZXhlYyA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKS5leGVjO1xuXG5cbnZhciByb290RGlyID0gcHJvY2Vzcy5lbnYuTk9fUFJFQ09NUElMRSA/IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUpIDogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJyk7XG5cbnZhciByZWxhdGl2ZSA9IHtcbiAgaXBob25lb3M6ICdidWlsZC9SZWxlYXNlLWlwaG9uZW9zL1Rlc3RBcHAtaXBob25lb3MuYXBwJyxcbiAgaXBob25lc2ltdWxhdG9yOiAnYnVpbGQvUmVsZWFzZS1pcGhvbmVzaW11bGF0b3IvVGVzdEFwcC1pcGhvbmVzaW11bGF0b3IuYXBwJ1xufTtcblxudmFyIGFic29sdXRlID0ge1xuICBpcGhvbmVvczogcGF0aC5yZXNvbHZlKHJvb3REaXIsICdidWlsZCcsICdSZWxlYXNlLWlwaG9uZW9zJywgJ1Rlc3RBcHAtaXBob25lb3MuYXBwJyksXG4gIGlwaG9uZXNpbXVsYXRvcjogcGF0aC5yZXNvbHZlKHJvb3REaXIsICdidWlsZCcsICdSZWxlYXNlLWlwaG9uZXNpbXVsYXRvcicsICdUZXN0QXBwLWlwaG9uZXNpbXVsYXRvci5hcHAnKVxufTtcblxudmFyIGFwcExpc3QgPSBbXG4gIHJlbGF0aXZlLmlwaG9uZW9zLFxuICByZWxhdGl2ZS5pcGhvbmVzaW11bGF0b3Jcbl07XG5cbnZhciBTREtTID0ge1xuICBpcGhvbmVzaW11bGF0b3I6IHtcbiAgICBuYW1lOiAnaXBob25lc2ltdWxhdG9yJyxcbiAgICBidWlsZFBhdGg6IHBhdGgucmVzb2x2ZSgnYnVpbGQnLCAnUmVsZWFzZS1pcGhvbmVzaW11bGF0b3InLCAnVGVzdEFwcC5hcHAnKSxcbiAgICBmaW5hbFBhdGg6IHJlbGF0aXZlLmlwaG9uZXNpbXVsYXRvclxuICB9LFxuICBpcGhvbmVvczoge1xuICAgIG5hbWU6ICdpcGhvbmVvcycsXG4gICAgYnVpbGRQYXRoOiBwYXRoLnJlc29sdmUoJ2J1aWxkJywgJ1JlbGVhc2UtaXBob25lb3MnLCAnVGVzdEFwcC5hcHAnKSxcbiAgICBmaW5hbFBhdGg6IHJlbGF0aXZlLmlwaG9uZW9zXG4gIH1cbn07XG5cbi8vIHRoZSBzZGtzIGFnYWluc3Qgd2hpY2ggd2Ugd2lsbCBidWlsZFxudmFyIHNka3MgPSBbJ2lwaG9uZXNpbXVsYXRvciddO1xuaWYgKHByb2Nlc3MuZW52LklPU19SRUFMX0RFVklDRSB8fCBwcm9jZXNzLmVudi5SRUFMX0RFVklDRSkge1xuICBzZGtzLnB1c2goJ2lwaG9uZW9zJyk7XG59XG5cbnZhciBNQVhfQlVGRkVSX1NJWkUgPSA1MjQyODg7XG5cbmZ1bmN0aW9uIGNsZWFuQXBwIChhcHBSb290LCBzZGssIGRvbmUpIHtcbiAgZ3V0aWwubG9nKCdjbGVhbmluZyBhcHAgZm9yICcgKyBzZGspO1xuICB2YXIgY21kID0gJ3hjb2RlYnVpbGQgLXNkayAnICsgc2RrICsgJyBjbGVhbic7XG4gIGV4ZWMoY21kLCB7Y3dkOiBhcHBSb290LCBtYXhCdWZmZXI6IE1BWF9CVUZGRVJfU0laRX0sIGZ1bmN0aW9uIChlcnIsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgZ3V0aWwubG9nKFwiRmFpbGVkIGNsZWFuaW5nIGFwcFwiKTtcbiAgICAgIGd1dGlsLmxvZyhzdGRlcnIpO1xuICAgICAgZG9uZShlcnIpO1xuICAgIH0gZWxzZSB7XG4gICAgICBndXRpbC5sb2coJ2ZpbmlzaGVkIGNsZWFuaW5nIGFwcCBmb3IgJyArIHNkayk7XG4gICAgICBkb25lKCk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gY2xlYW5BbGwgKGRvbmUpIHtcbiAgZ3V0aWwubG9nKFwiY2xlYW5pbmcgYXBwc1wiKTtcbiAgeGNvZGUuZ2V0TWF4SU9TU0RLKClcbiAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgZ3V0aWwubG9nKFwiVW5hYmxlIHRvIGdldCBtYXggaU9TIFNESzpcIiwgZXJyLm1lc3NhZ2UpO1xuICAgIH0pXG4gICAgLnRoZW4oZnVuY3Rpb24gKHNka1Zlcikge1xuICAgICAgYXN5bmNVdGlsLmVhY2hTZXJpZXMoc2RrcywgZnVuY3Rpb24gKHNkaywgY2IpIHtcbiAgICAgICAgY2xlYW5BcHAoJy4nLCBzZGsgKyBzZGtWZXIsIGNiKTtcbiAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgaWYgKGVycikgcmV0dXJuIGRvbmUoZXJyKTtcbiAgICAgICAgYXN5bmNVdGlsLmVhY2hTZXJpZXMoW1xuICAgICAgICAgIFNES1MuaXBob25lc2ltdWxhdG9yLmJ1aWxkUGF0aCxcbiAgICAgICAgICBTREtTLmlwaG9uZXNpbXVsYXRvci5maW5hbFBhdGgsXG4gICAgICAgICAgU0RLUy5pcGhvbmVvcy5idWlsZFBhdGgsXG4gICAgICAgICAgU0RLUy5pcGhvbmVvcy5maW5hbFBhdGhcbiAgICAgICAgXSwgcmltcmFmLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgaWYgKGVycikgcmV0dXJuIGRvbmUoZXJyKTtcbiAgICAgICAgICBndXRpbC5sb2coXCJmaW5pc2hlZCBjbGVhbmluZyBhcHBzXCIpO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gYnVpbGRBcHAgKGFwcFJvb3QsIHNkaywgZG9uZSkge1xuICBndXRpbC5sb2coJ2J1aWxkaW5nIGFwcCBmb3IgJyArIHNkayk7XG4gIHZhciBjbWQgPSAneGNvZGVidWlsZCAtc2RrICcgKyBzZGs7XG4gIGV4ZWMoY21kLCB7Y3dkOiBhcHBSb290LCBtYXhCdWZmZXI6IE1BWF9CVUZGRVJfU0laRX0sIGZ1bmN0aW9uIChlcnIsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgZ3V0aWwubG9nKFwiRmFpbGVkIGJ1aWxkaW5nIGFwcFwiKTtcbiAgICAgIGd1dGlsLmxvZyhzdGRlcnIpO1xuICAgICAgZG9uZShlcnIpO1xuICAgIH0gZWxzZSB7XG4gICAgICBndXRpbC5sb2coJ2ZpbmlzaGVkIGJ1aWxkaW5nIGFwcCBmb3IgJyArIHNkayk7XG4gICAgICBkb25lKCk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gYnVpbGRBbGwgKGRvbmUpIHtcbiAgZ3V0aWwubG9nKCdidWlsZGluZyBhcHBzJyk7XG4gIHhjb2RlLmdldE1heElPU1NESygpXG4gICAgLnRoZW4oZnVuY3Rpb24gKHNka1Zlcikge1xuICAgICAgYXN5bmNVdGlsLmVhY2hTZXJpZXMoc2RrcywgZnVuY3Rpb24gKHNkaywgY2IpIHtcbiAgICAgICAgYnVpbGRBcHAoJy4nLCBzZGsgKyBzZGtWZXIsIGNiKTtcbiAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgaWYgKGVycikgcmV0dXJuIGRvbmUoZXJyKTtcbiAgICAgICAgZ3V0aWwubG9nKCdmaW5pc2hlZCBidWlsZGluZyBhcHBzJyk7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuIH1cblxuZnVuY3Rpb24gcmVuYW1lQWxsIChkb25lKSB7XG4gIGd1dGlsLmxvZygncmVuYW1pbmcgYXBwcycpO1xuICBhc3luY1V0aWwuZWFjaFNlcmllcyhzZGtzLCBmdW5jdGlvbiAoc2RrLCBjYikge1xuICAgIGd1dGlsLmxvZygncmVuYW1pbmcgZm9yICcgKyBzZGspO1xuICAgIGZzLnJlbmFtZShTREtTW3Nka10uYnVpbGRQYXRoLCBTREtTW3Nka10uZmluYWxQYXRoLCBjYik7XG4gIH0sIGZ1bmN0aW9uIChlcnIpIHtcbiAgICBpZiAoZXJyKSByZXR1cm4gZG9uZShlcnIpO1xuICAgIGd1dGlsLmxvZygnZmluaXNoZWQgcmVuYW1pbmcgYXBwcycpO1xuICAgIGRvbmUoKTtcbiAgfSk7XG59XG5cbmV4cG9ydHMuaW5zdGFsbCA9IGZ1bmN0aW9uIGluc3RhbGwgKGRvbmUpIHtcbiAgYXN5bmNVdGlsLnNlcmllcyhbXG4gICAgY2xlYW5BbGwsXG4gICAgYnVpbGRBbGwsXG4gICAgcmVuYW1lQWxsLFxuICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgIGlmICh0eXBlb2YgZG9uZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBkb25lKCk7XG4gICAgICB9XG4gICAgfVxuICBdKTtcbn07XG5cbmV4cG9ydHMuaW5zdGFsbFJlYWxEZXZpY2UgPSBmdW5jdGlvbiBpbnN0YWxsUmVhbERldmljZSAoZG9uZSkge1xuICBzZGtzID0gWydpcGhvbmVvcyddO1xuICBleHBvcnRzLmluc3RhbGwoZnVuY3Rpb24gKCkge1xuICAgIGRvbmUoU0RLUy5pcGhvbmVvcy5maW5hbFBhdGgpO1xuICB9KTtcbn07XG5cbmV4cG9ydHMucmVsYXRpdmUgPSByZWxhdGl2ZTtcbmV4cG9ydHMuYWJzb2x1dGUgPSBhYnNvbHV0ZTtcbmV4cG9ydHMuYXBwTGlzdCA9IGFwcExpc3Q7XG5cbmlmIChyZXF1aXJlLm1haW4gPT09IG1vZHVsZSkge1xuICBleHBvcnRzLmluc3RhbGwoZnVuY3Rpb24gKCkge1xuICAgIGNvbnNvbGUubG9nKCdmaW5pc2hlZCBpbnN0YWxsaW5nJyk7XG4gIH0pO1xufVxuIl0sInNvdXJjZVJvb3QiOiIuLiJ9
